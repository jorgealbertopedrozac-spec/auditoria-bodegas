<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nueva Evaluaci贸n - Auditor铆a</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #2c3e50; --success: #27ae60; --danger: #e74c3c; --bg: #f4f7f6; }
        body { font-family: sans-serif; background: var(--bg); padding: 15px; }
        .container { max-width: 600px; margin: auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .pregunta-card { border: 1px solid #eee; padding: 15px; border-radius: 8px; margin-bottom: 15px; background: #fff; }
        .opciones { display: flex; gap: 10px; margin-top: 10px; }
        .btn-check { flex: 1; padding: 10px; border: 2px solid #ddd; border-radius: 6px; cursor: pointer; background: white; font-weight: bold; }
        
        /* Estilos cuando se selecciona una opci贸n */
        input[type="radio"]:checked + label.conforme { background: var(--success); color: white; border-color: var(--success); }
        input[type="radio"]:checked + label.no-conforme { background: var(--danger); color: white; border-color: var(--danger); }
        input[type="radio"] { display: none; }

        select, button#finalizar { width: 100%; padding: 12px; margin-top: 10px; border-radius: 6px; border: 1px solid #ccc; font-size: 16px; }
        button#finalizar { background: var(--primary); color: white; border: none; font-weight: bold; cursor: pointer; margin-top: 20px; }
    </style>
</head>
<body>

<div class="container">
    <h2> Nueva Evaluaci贸n</h2>
    
    <label>Selecciona Bodega:</label>
    <select id="selectBodega">
        <option value="">Cargando bodegas...</option>
    </select>

    <div id="listaPreguntas" style="margin-top: 20px;">
        </div>

    <button id="finalizar" onclick="enviarEvaluacion()">Finalizar y Guardar</button>
</div>

<script>
    const SUPABASE_URL = 'https://xjckzbegtvianurfvubp.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhqY2t6YmVndHZpYW51cmZ2dWJwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxOTYzMzUsImV4cCI6MjA4Mjc3MjMzNX0.64zrKi0p1KiDwtBODLRf8O4sRvnn0o9QyoQUYHvVFd0';
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let preguntasData = [];

    async function iniciar() {
        // 1. Cargar Bodegas
        const { data: bodegas } = await _supabase.from('bodegas').select('*');
        const select = document.getElementById('selectBodega');
        select.innerHTML = bodegas.map(b => `<option value="${b.id}">${b.nombre}</option>`).join('');

        // 2. Cargar Preguntas del Configurador
        const { data: preguntas } = await _supabase.from('configuracion_preguntas').select('*');
        preguntasData = preguntas;
        
        const contenedor = document.getElementById('listaPreguntas');
        contenedor.innerHTML = preguntas.map((p, index) => `
            <div class="pregunta-card">
                <small>${p.titulo} > ${p.desglose}</small>
                <p><strong>${p.pregunta}</strong></p>
                <div class="opciones">
                    <input type="radio" name="p-${index}" id="c-${index}" value="true">
                    <label for="c-${index}" class="btn-check conforme">CONFORME</label>
                    
                    <input type="radio" name="p-${index}" id="nc-${index}" value="false">
                    <label for="nc-${index}" class="btn-check no-conforme">NO CONFORME</label>
                </div>
            </div>
        `).join('');
    }

    async function enviarEvaluacion() {
        const bodegaId = document.getElementById('selectBodega').value;
        let puntosObtenidos = 0;
        let puntosTotales = 0;
        const respuestasParaSubir = [];

        // Calcular resultados
        preguntasData.forEach((p, index) => {
            const conforme = document.getElementById(`c-${index}`).checked;
            const noConforme = document.getElementById(`nc-${index}`).checked;

            if (conforme || noConforme) {
                const valor = conforme ? p.ponderacion : 0;
                puntosObtenidos += valor;
                puntosTotales += p.ponderacion;
                
                respuestasParaSubir.push({
                    pregunta_id: p.id,
                    cumple: conforme,
                    puntos_obtenidos: valor
                });
            }
        });

        if (respuestasParaSubir.length < preguntasData.length) {
            return alert("Por favor responde todas las preguntas.");
        }

        const calificacionFinal = (puntosObtenidos / puntosTotales) * 100;

        // Guardar en Supabase
        const { data: evalData, error: evalError } = await _supabase
            .from('evaluaciones')
            .insert([{ 
                bodega_id: bodegaId, 
                calificacion_final: calificacionFinal.toFixed(2),
                tipo: 'Semanal' 
            }])
            .select();

        if (evalError) return alert("Error al guardar evaluaci贸n");

        // Guardar detalles de respuestas
        const finalRespuestas = respuestasParaSubir.map(r => ({...r, evaluacion_id: evalData[0].id}));
        await _supabase.from('respuestas').insert(finalRespuestas);

        alert(`Evaluaci贸n guardada con 茅xito. Calificaci贸n: ${calificacionFinal.toFixed(2)}%`);
        location.reload();
    }

    iniciar();
</script>
</body>
</html>

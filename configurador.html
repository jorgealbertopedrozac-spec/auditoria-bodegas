<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Configuraci√≥n de Auditor√≠a</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #2c3e50; --secondary: #3498db; --accent: #27ae60; --bg: #f8f9fa; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        .container { max-width: 900px; margin: auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        /* Pesta√±as */
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #eee; }
        .tab { padding: 10px 20px; cursor: pointer; border: none; background: none; font-weight: bold; color: #7f8c8d; }
        .tab.active { color: var(--secondary); border-bottom: 3px solid var(--secondary); }
        
        .section { display: none; }
        .section.active { display: block; }

        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; background: #f1f4f6; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        label { display: block; font-size: 0.85em; font-weight: bold; margin-bottom: 5px; color: #555; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
        
        button.btn-add { background: var(--accent); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; width: 100%; grid-column: 1 / -1; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.9em; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #eee; }
        th { background: #fdfdfd; color: var(--primary); }
        .badge { background: #e8f4fd; color: #2980b9; padding: 3px 8px; border-radius: 4px; font-size: 0.8em; }
    </style>
</head>
<body>

<div class="container">
    <h2>‚öôÔ∏è Panel de Administraci√≥n</h2>
    
    <div class="tabs">
        <button class="tab active" onclick="showTab('tab-bodegas')">üìç Bodegas</button>
        <button class="tab" onclick="showTab('tab-preguntas')">‚ùì Cat√°logo de Preguntas</button>
    </div>

    <div id="tab-bodegas" class="section active">
        <div class="form-grid">
            <div>
                <label>Localizaci√≥n (Ciudad)</label>
                <input type="text" id="b-loc" placeholder="Ej: Aguascalientes">
            </div>
            <div>
                <label>Departamento</label>
                <input type="text" id="b-dep" placeholder="Ej: Cer√°micos">
            </div>
            <div>
                <label>Nombre de Bodega (ID)</label>
                <input type="text" id="b-nom" placeholder="Ej: CC">
            </div>
            <button class="btn-add" onclick="guardarBodega()">Registrar Bodega</button>
        </div>
        <table id="tablaBodegas">
            <thead><tr><th>Localizaci√≥n</th><th>Departamento</th><th>Bodega</th><th>Acci√≥n</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>

    <div id="tab-preguntas" class="section">
        <div class="form-grid">
            <div>
                <label>Secci√≥n (T√≠tulo)</label>
                <input type="text" id="p-tit" placeholder="1. Identificaci√≥n...">
            </div>
            <div>
                <label>Sub-secci√≥n (Desglose)</label>
                <input type="text" id="p-des" placeholder="1.1 √Åreas identificadas...">
            </div>
            <div>
                <label>Peso (Puntos)</label>
                <input type="number" id="p-pts" value="10">
            </div>
            <div style="grid-column: 1 / -1;">
                <label>Pregunta Espec√≠fica</label>
                <textarea id="p-pre" rows="2"></textarea>
            </div>
            <button class="btn-add" onclick="guardarPregunta()">A√±adir al Cat√°logo</button>
        </div>
        <table id="tablaPreguntas">
            <thead><tr><th>Secci√≥n / Desglose</th><th>Pregunta</th><th>Peso</th><th>Acci√≥n</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<script>
    const SUPABASE_URL = 'https://xjckzbegtvianurfvubp.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhqY2t6YmVndHZpYW51cmZ2dWJwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxOTYzMzUsImV4cCI6MjA4Mjc3MjMzNX0.64zrKi0p1KiDwtBODLRf8O4sRvnn0o9QyoQUYHvVFd0';
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // Navegaci√≥n de pesta√±as
    function showTab(id) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        event.target.classList.add('active');
        if(id === 'tab-bodegas') cargarBodegas();
        else cargarPreguntas();
    }

    // --- L√ìGICA BODEGAS ---
    async function cargarBodegas() {
        const { data } = await _supabase.from('bodegas').select('*').order('localizacion');
        const tbody = document.querySelector('#tablaBodegas tbody');
        tbody.innerHTML = data.map(b => `
            <tr>
                <td>${b.localizacion}</td>
                <td>${b.departamento}</td>
                <td><strong>${b.nombre}</strong></td>
                <td><button onclick="eliminar('bodegas','${b.id}')">üóëÔ∏è</button></td>
            </tr>
        `).join('');
    }

    async function guardarBodega() {
        const loc = document.getElementById('b-loc').value;
        const dep = document.getElementById('b-dep').value;
        const nom = document.getElementById('b-nom').value;
        if(!loc || !dep || !nom) return alert("Completa todos los campos");

        await _supabase.from('bodegas').insert([{ localizacion: loc, departamento: dep, nombre: nom }]);
        document.getElementById('b-nom').value = '';
        cargarBodegas();
    }

    // --- L√ìGICA PREGUNTAS ---
    async function cargarPreguntas() {
        const { data } = await _supabase.from('configuracion_preguntas').select('*').order('titulo');
        const tbody = document.querySelector('#tablaPreguntas tbody');
        tbody.innerHTML = data.map(p => `
            <tr>
                <td><small>${p.titulo}</small><br><strong>${p.desglose}</strong></td>
                <td>${p.pregunta}</td>
                <td><span class="badge">${p.ponderacion} pts</span></td>
                <td><button onclick="eliminar('configuracion_preguntas','${p.id}')">üóëÔ∏è</button></td>
            </tr>
        `).join('');
    }

    async function guardarPregunta() {
        const tit = document.getElementById('p-tit').value;
        const des = document.getElementById('p-des').value;
        const pre = document.getElementById('p-pre').value;
        const pts = document.getElementById('p-pts').value;

        await _supabase.from('configuracion_preguntas').insert([{ 
            titulo: tit, desglose: des, pregunta: pre, ponderacion: parseFloat(pts) 
        }]);
        document.getElementById('p-pre').value = '';
        cargarPreguntas();
    }

    async function eliminar(tabla, id) {
        if(confirm("¬øEliminar registro?")) {
            await _supabase.from(tabla).delete().eq('id', id);
            tabla === 'bodegas' ? cargarBodegas() : cargarPreguntas();
        }
    }

    cargarBodegas();
</script>
</body>
</html>
